<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Elevate Tracker â€” PWA (Embedded Icon)</title>

<!-- iOS full-screen + title -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Elevate Tracker">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Theme color -->
<meta name="theme-color" content="#0a1a2b">

<!-- Weâ€™ll inject the manifest + icons at runtime (all embedded / no files) -->
<link id="dyn-manifest" rel="manifest">
<link id="dyn-apple-icon" rel="apple-touch-icon">
<link id="dyn-favicon" rel="icon" type="image/png">

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
  :root{
    /* Elevate navy + metallic gold gradient */
    --navy:#0a1a2b;
    --navy-2:#06202f;
    --gold:#f3c14b;
    --gold-2:#ffdf8a;
    --green:#004d40; /* for some charts and accents already used in tracker */
    --ink:#222; --muted:#666;
    --bg:#f6f6f6; --grid:#e0e0e0; --card:#ffffff; --line:#e6e6e6;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,Arial,sans-serif;background:var(--bg);margin:0;color:var(--ink)}

  .wrap{max-width:1200px;margin:18px auto;background:#fff;border-radius:12px;
        box-shadow:0 10px 28px rgba(0,0,0,.08);overflow:hidden}
  .head{
    background:linear-gradient(180deg,var(--navy),var(--navy-2));
    color:var(--gold);
    padding:20px 16px;border-bottom:4px solid #03121f;text-align:center
  }
  .head h1{margin:0;font-weight:800;letter-spacing:.2px}
  .head .sub{color:#fff;opacity:.9;margin-top:6px}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;padding:12px 16px;background:#eef1ee;border-bottom:2px solid #ddd}
  .tab{-webkit-tap-highlight-color:transparent;padding:10px 14px;background:#fff;color:#123;border:1px solid #d6d6d6;border-radius:999px;
       font-weight:800;cursor:pointer;user-select:none;transition:transform .08s ease, box-shadow .2s ease, background .15s ease, border-color .15s ease}
  .tab:hover{background:#fafafa}
  .tab:active{transform:translateY(1px)}
  .tab.active{
    background:linear-gradient(180deg,var(--gold-2),var(--gold));
    color:#0a0a0a;border-color:var(--gold);box-shadow:0 10px 20px rgba(251,192,45,.25)
  }

  .sheet{display:none;padding:16px;opacity:0;transform:translateY(4px);transition:opacity .18s ease, transform .18s ease}
  .sheet.active{display:block;opacity:1;transform:none}
  .section{background:linear-gradient(180deg,var(--navy),var(--navy-2));color:var(--gold);padding:10px;border-radius:8px;text-align:center;margin:12px 0;font-weight:800}

  .grid{display:grid;grid-template-columns:180px 1fr 180px 1fr;gap:2px;background:var(--grid);border:2px solid #bdbdbd;margin-bottom:16px}
  .cell{background:#fff;border:1px solid #ddd;padding:10px;min-height:38px;display:flex;align-items:center;font-size:14px}
  .label{
    background:linear-gradient(180deg,#e9f5eb,#d2ead6);
    border-right:2px solid var(--navy);font-weight:700
  }
  .result{background:#fff7da;font-weight:800;color:#6b5200;justify-content:center}
  input,select,textarea{width:100%;border:none;background:transparent;font-size:14px;outline:none}
  textarea{min-height:60px;resize:vertical}

  .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px}
  .cards{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin:12px 0}
  .calc-card{
    border:2px solid var(--gold);border-radius:12px;text-align:center;padding:14px;font-weight:800;
    background:linear-gradient(180deg,#fff, #fffdf4)
  }
  .calc-card .value{display:block;color:var(--navy);font-size:28px;margin-top:6px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .tight{max-width:940px;margin:0 auto}

  table{width:100%;border-collapse:collapse}
  th{background:linear-gradient(180deg,var(--navy),var(--navy-2));color:var(--gold);padding:10px}
  td{border:1px solid #e6e6e6;padding:8px;text-align:center}

  .macro-row{display:grid;grid-template-columns:140px 1fr 140px 1fr 140px 1fr;gap:10px;margin:10px 0}
  .macro-row label{display:flex;align-items:center;font-weight:700}
  .macro-row input{border:1px solid #d6d6d6;border-radius:6px;padding:8px;background:#fff}
  .macro-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .summary-box{background:#fafafa;border:1px solid #eee;border-radius:8px;padding:10px;text-align:center}
  .summary-box .big{display:block;font-size:18px;font-weight:800;color:#004d40;margin-top:6px}
  .macro-note{font-size:12px;color:#555;margin-top:6px;text-align:center}

  .weightlog{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin:10px 0}
  .weightlog input{border:1px solid #d6d6d6;border-radius:6px;padding:8px;background:#fff}
  .btn{padding:9px 14px;border:1px solid var(--navy);background:#fff;border-radius:8px;font-weight:700;cursor:pointer}
  .btn:hover{background:#f8fbff}

  .foot{padding:10px;text-align:center;color:#666;border-top:1px solid #eee;font-size:12px;background:#fafafa}

  @media(max-width:1100px){
    .grid{grid-template-columns:1fr 1fr}
    .cards{grid-template-columns:1fr 1fr}
    .two{grid-template-columns:1fr}
    .macro-row{grid-template-columns:1fr 1fr}
    .macro-summary{grid-template-columns:1fr}
    .weightlog{grid-template-columns:1fr 1fr}
  }
  @media print{ .tabs{display:none!important} body{background:#fff} .wrap{box-shadow:none} .sheet{display:block!important} }
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="Elevate Tracker">
  <div class="head">
    <h1>Elevate Tracker</h1>
    <div class="sub">BMR â€¢ BMI â€¢ Body Composition â€¢ Macros â€¢ Measurements â€¢ Progress â€¢ Client Profile</div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabbar" role="tablist" aria-label="Tracker Tabs">
    <div class="tab active" data-sheet="bmr" role="tab" aria-selected="true" tabindex="0">BMR</div>
    <div class="tab" data-sheet="bmi" role="tab" aria-selected="false" tabindex="-1">BMI</div>
    <div class="tab" data-sheet="bodycomp" role="tab" aria-selected="false" tabindex="-1">Body Comp</div>
    <div class="tab" data-sheet="macros" role="tab" aria-selected="false" tabindex="-1">Macros</div>
    <div class="tab" data-sheet="meas" role="tab" aria-selected="false" tabindex="-1">Measurements</div>
    <div class="tab" data-sheet="prog" role="tab" aria-selected="false" tabindex="-1">Progress</div>
    <div class="tab" data-sheet="profile" role="tab" aria-selected="false" tabindex="-1">Client Profile</div>
  </div>

  <!-- BMR (+ NEAT) -->
  <section id="bmr" class="sheet active tight" role="tabpanel" aria-label="BMR">
    <div class="section">Basal Metabolic Rate (Mifflinâ€“St Jeor) â€¢ NEAT â€¢ Daily Targets</div>
    <div class="grid">
      <div class="cell label">Age (years)</div><div class="cell"><input id="bmr_age" type="number" min="10" step="1" placeholder="30"></div>
      <div class="cell label">Gender</div><div class="cell">
        <select id="bmr_gender"><option value="male">Male</option><option value="female">Female</option></select>
      </div>
      <div class="cell label">Height (cm)</div><div class="cell"><input id="bmr_height" type="number" step="0.1" placeholder="175"></div>
      <div class="cell label">Weight (kg)</div><div class="cell"><input id="bmr_weight" type="number" step="0.1" placeholder="75.0"></div>

      <div class="cell label">Activity Level</div>
      <div class="cell">
        <select id="bmr_activity">
          <option value="1.2">Sedentary</option>
          <option value="1.375">Light</option>
          <option value="1.55" selected>Moderate</option>
          <option value="1.725">Active</option>
          <option value="1.9">Very Active</option>
        </select>
      </div>
      <div class="cell label">Calorie Adjustment</div>
      <div class="cell">
        <select id="bmr_adjust">
          <option value="-500">-500 (Cut)</option>
          <option value="-300">-300</option>
          <option value="-200">-200</option>
          <option value="0" selected>0 (Maintain)</option>
          <option value="200">+200</option>
          <option value="300">+300</option>
          <option value="500">+500 (Bulk)</option>
        </select>
      </div>

      <div class="cell label">BMR Result</div><div class="cell result" id="bmr_out">0</div>
      <div class="cell label">TDEE (BMR Ã— Activity)</div><div class="cell result" id="bmr_tdee">0</div>
      <div class="cell label">Target Calories</div><div class="cell result" id="bmr_target">0</div>

      <!-- NEAT -->
      <div class="cell label">Daily Steps (NEAT)</div><div class="cell"><input id="neat_steps" type="number" min="0" step="100" placeholder="e.g., 8000"></div>
      <div class="cell label">kcal per step</div><div class="cell"><input id="neat_kps" type="number" min="0" step="0.001" value="0.045"></div>
      <div class="cell label">NEAT kcal/day</div><div class="cell result" id="neat_out">0</div>
      <div class="cell label">Use NEAT to refine TDEE</div>
      <div class="cell"><label style="display:flex;align-items:center;gap:8px;"><input id="neat_use" type="checkbox"> <span>Refined TDEE = max(BMRÃ—Activity, BMR+NEAT)</span></label></div>

      <div class="cell label">TDEE (Refined)</div><div class="cell result" id="bmr_tdee_ref">0</div>
      <div class="cell label">Target (Refined Basis)</div><div class="cell result" id="bmr_target_basis">Baseline</div>
    </div>

    <div class="cards">
      <div class="calc-card">ðŸ”¥ BMR <span class="value" id="mc_bmr">0</span>cal/day</div>
      <div class="calc-card">ðŸ”¥ TDEE <span class="value" id="mc_tdee">0</span>cal/day</div>
      <div class="calc-card">ðŸ”¥ Target Calories <span class="value" id="mc_target">0</span>cal/day</div>
      <div class="calc-card">ðŸ”¥ NEAT <span class="value" id="mc_neat">0</span>cal/day</div>
      <div class="calc-card">ðŸ”¥ TDEE (Refined) <span class="value" id="mc_tdee_ref">0</span>cal/day</div>
    </div>
  </section>

  <!-- BMI -->
  <section id="bmi" class="sheet tight" role="tabpanel" aria-label="BMI">
    <div class="section">Body Mass Index</div>
    <div class="grid">
      <div class="cell label">Height (cm)</div><div class="cell"><input id="bmi_height" type="number" step="0.1"></div>
      <div class="cell label">Weight (kg)</div><div class="cell"><input id="bmi_weight" type="number" step="0.1"></div>
      <div class="cell label">BMI</div><div class="cell result" id="bmi_out">0</div>
      <div class="cell label">Category</div><div class="cell result" id="bmi_cat">â€”</div>
    </div>
  </section>

  <!-- Body Comp -->
  <section id="bodycomp" class="sheet tight" role="tabpanel" aria-label="Body Composition">
    <div class="section">Body Composition</div>
    <div class="grid">
      <div class="cell label">Weight (kg)</div><div class="cell"><input id="bc_weight" type="number" step="0.1"></div>
      <div class="cell label">Body Fat %</div><div class="cell"><input id="bc_bf" type="number" step="0.1" min="3" max="60"></div>
      <div class="cell label">Lean Mass</div><div class="cell result" id="bc_lean">0</div>
      <div class="cell label">Fat Mass</div><div class="cell result" id="bc_fat">0</div>
    </div>
  </section>

  <!-- Macros -->
  <section id="macros" class="sheet tight" role="tabpanel" aria-label="Macros">
    <div class="section">Macro Planning</div>
    <div class="macro-row">
      <label for="pPct">Protein %</label>
      <input id="pPct" type="number" value="30" min="0" max="100" />
      <label for="fPct">Fat %</label>
      <input id="fPct" type="number" value="30" min="0" max="100" />
      <label for="cPct">Carbs %</label>
      <input id="cPct" type="number" value="40" min="0" max="100" readonly />
    </div>
    <div class="macro-note">Edit <strong>Protein</strong> and <strong>Fat</strong>. <strong>Carbs</strong> auto-fills so total = 100%.</div>

    <div class="macro-summary">
      <div class="summary-box">Protein (kcal / g)
        <span class="big"><span id="pCals">0</span> / <span id="pGr">0</span>g</span>
      </div>
      <div class="summary-box">Carbs (kcal / g)
        <span class="big"><span id="cCals">0</span> / <span id="cGr">0</span>g</span>
      </div>
      <div class="summary-box">Fat (kcal / g)
        <span class="big"><span id="fCals">0</span> / <span id="fGr">0</span>g</span>
      </div>
    </div>

    <div class="two" style="margin-top:14px">
      <div class="card"><canvas id="macroChart" style="max-height:340px"></canvas></div>
      <div class="card">
        <div class="section" style="margin-top:0">Meal Timing</div>
        <table>
          <tr><th>Meal</th><th>Protein (g)</th><th>Carbs (g)</th><th>Fat (g)</th><th>Calories</th></tr>
          <tr><td>Breakfast</td><td id="m1P">0</td><td id="m1C">0</td><td id="m1F">0</td><td id="m1K">0</td></tr>
          <tr><td>Lunch</td><td id="m2P">0</td><td id="m2C">0</td><td id="m2F">0</td><td id="m2K">0</td></tr>
          <tr><td>Dinner</td><td id="m3P">0</td><td id="m3C">0</td><td id="m3F">0</td><td id="m3K">0</td></tr>
          <tr><td>Snacks</td><td id="sP">0</td><td id="sC">0</td><td id="sF">0</td><td id="sK">0</td></tr>
        </table>
      </div>
    </div>
    <div class="card" style="margin-top:12px"><canvas id="mealChart" style="max-height:300px"></canvas></div>
  </section>

  <!-- Measurements -->
  <section id="meas" class="sheet tight" role="tabpanel" aria-label="Measurements">
    <div class="section">Body Measurements</div>
    <div class="card">
      <table>
        <tr><th>Measurement</th><th>W1</th><th>W4</th><th>W8</th><th>W12</th><th>Change</th></tr>
        <tr>
          <td>Weight (kg)</td>
          <td><input id="weight1" type="number" step="0.1"></td>
          <td><input id="weight4" type="number" step="0.1"></td>
          <td><input id="weight8" type="number" step="0.1"></td>
          <td><input id="weight12" type="number" step="0.1"></td>
          <td id="weightChange">0 kg</td>
        </tr>
        <tr>
          <td>Body Fat %</td>
          <td><input id="bf1" type="number" step="0.1"></td>
          <td><input id="bf4" type="number" step="0.1"></td>
          <td><input id="bf8" type="number" step="0.1"></td>
          <td><input id="bf12" type="number" step="0.1"></td>
          <td id="bfChange">0%</td>
        </tr>
        <tr>
          <td>Waist (cm)</td>
          <td><input id="waist1" type="number" step="0.1"></td>
          <td><input id="waist4" type="number" step="0.1"></td>
          <td><input id="waist8" type="number" step="0.1"></td>
          <td><input id="waist12" type="number" step="0.1"></td>
          <td id="waistChange">0 cm</td>
        </tr>
      </table>
    </div>
  </section>

  <!-- Progress -->
  <section id="prog" class="sheet tight" role="tabpanel" aria-label="Progress">
    <div class="section">Progress</div>
    <div class="card">
      <table>
        <tr><th>Goal</th><th>Current</th><th>Target</th><th>Diff</th></tr>
        <tr><td>Weight (kg)</td><td><input id="curW" type="number" step="0.1"></td><td><input id="tarW" type="number" step="0.1"></td><td id="diffW">0</td></tr>
        <tr><td>Body Fat %</td><td><input id="curBF" type="number" step="0.1"></td><td><input id="tarBF" type="number" step="0.1"></td><td id="diffBF">0</td></tr>
      </table>
    </div>

    <div class="section" style="margin-top:14px">Daily Weight Log</div>
    <div class="weightlog">
      <input id="logDate" type="date" />
      <input id="logWeight" type="number" step="0.1" placeholder="Today's weight (kg)" />
      <button class="btn" id="addLog">Save Entry</button>
    </div>
    <div class="card">
      <table id="logTable"><tr><th>Date</th><th>Weight (kg)</th></tr></table>
    </div>
    <div class="card" style="margin-top:12px"><canvas id="progressChart"></canvas></div>
  </section>

  <!-- Client Profile -->
  <section id="profile" class="sheet tight" role="tabpanel" aria-label="Client Profile">
    <div class="section">CLIENT PROFILE & ASSESSMENT</div>
    <div class="card">
      <h3>Personal Information</h3>
      <div class="grid">
        <div class="cell label">Full Name</div><div class="cell"><input id="profile_fullname" type="text" placeholder="First & Last name"></div>
        <div class="cell label">Age</div><div class="cell"><input id="profile_age" type="number" min="10" step="1" placeholder="Years"></div>
        <div class="cell label">Gender</div>
        <div class="cell">
          <select id="profile_gender">
            <option value="">Selectâ€¦</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other / Prefer not to say</option>
          </select>
        </div>
        <div class="cell label">Phone</div><div class="cell"><input id="profile_phone" type="tel" placeholder="+44â€¦"></div>
        <div class="cell label">Email</div><div class="cell"><input id="profile_email" type="email" placeholder="name@example.com"></div>
        <div class="cell label">Emergency Contact</div><div class="cell"><input id="profile_emergency" type="text" placeholder="Name & phone"></div>
      </div>

      <div class="grid">
        <div class="cell label">Medical History & Conditions</div><div class="cell"><textarea id="profile_medical" placeholder="e.g., asthma, hypertension, surgeries"></textarea></div>
        <div class="cell label">Medications & Supplements</div><div class="cell"><textarea id="profile_meds" placeholder="List all current meds/supps"></textarea></div>
        <div class="cell label">Injuries & Physical Limitations</div><div class="cell"><textarea id="profile_injuries" placeholder="e.g., lower back pain, shoulder impingement"></textarea></div>
        <div class="cell label">Fitness Experience Level</div>
        <div class="cell"><select id="profile_experience"><option value="">Selectâ€¦</option><option>Beginner</option><option>Intermediate</option><option>Advanced</option></select></div>
        <div class="cell label">Lifestyle â€” Job Type</div><div class="cell"><input id="profile_job" type="text" placeholder="e.g., desk-based, manual labour"></div>
        <div class="cell label">Lifestyle â€” Stress Level</div><div class="cell"><select id="profile_stress"><option value="">Selectâ€¦</option><option>Low</option><option>Moderate</option><option>High</option></select></div>
        <div class="cell label">Sleep Quality</div><div class="cell"><select id="profile_sleep_quality"><option value="">Selectâ€¦</option><option>Poor</option><option>Fair</option><option>Good</option><option>Excellent</option></select></div>
        <div class="cell label">Sleep Hours (avg)</div><div class="cell"><input id="profile_sleep_hours" type="number" min="0" step="0.5" placeholder="e.g., 7.5"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Initial Assessment</h3>
      <div class="grid">
        <div class="cell label">Fitness Goals â€” Primary</div><div class="cell"><textarea id="profile_goal_primary" placeholder="Main objective"></textarea></div>
        <div class="cell label">Fitness Goals â€” Secondary</div><div class="cell"><textarea id="profile_goal_secondary" placeholder="Additional objectives"></textarea></div>
        <div class="cell label">Timeline â€” Start Date</div><div class="cell"><input id="profile_start_date" type="date"></div>
        <div class="cell label">Timeline â€” Target Date</div><div class="cell"><input id="profile_target_date" type="date"></div>
        <div class="cell label">Motivation Level</div><div class="cell"><select id="profile_motivation"><option value="">Selectâ€¦</option><option>Low</option><option>Moderate</option><option>High</option><option>Very High</option></select></div>
        <div class="cell label">Barriers</div><div class="cell"><textarea id="profile_barriers" placeholder="e.g., time, injury, confidence"></textarea></div>
        <div class="cell label">Preferred Exercise Types</div><div class="cell"><textarea id="profile_preferred" placeholder="e.g., weights, HIIT, running, classes"></textarea></div>
      </div>
    </div>
  </section>

  <div style="text-align:center;padding:16px">
    <button class="btn" onclick="exportDataEmail('')">ðŸ“§ Export & Email</button>
  </div>

  <div class="foot">Elevate Tracker â€¢ Â©</div>
</div>

<script>
(()=>{
  const $ = id => document.getElementById(id);
  const N = v => (v===''||v==null)?0:(isFinite(+v)?+v:0);
  const LS = 'elevate_tracker_full_pwa_v1';

  /* ---------- Tabs ---------- */
  const tabbar = document.getElementById('tabbar');
  const tabs = [...tabbar.querySelectorAll('.tab')];
  function show(id){
    document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('active'));
    const p = document.getElementById(id); if(p) p.classList.add('active');
    tabs.forEach(t=>{
      const on = t.dataset.sheet===id;
      t.classList.toggle('active', on);
      t.setAttribute('aria-selected', on?'true':'false');
      t.setAttribute('tabindex', on?'0':'-1');
    });
    if(location.hash!=='#'+id) history.replaceState(null,'','#'+id);
  }
  tabbar.addEventListener('click', e=>{
    const t = e.target.closest('.tab'); if(!t) return; show(t.dataset.sheet);
  });
  const initial=(location.hash||'#bmr').slice(1);
  show(document.getElementById(initial)?initial:'bmr');

  /* ---------- Persistence ---------- */
  function save(){
    const data={};
    document.querySelectorAll('input,select,textarea').forEach(el=>{ if(el.id) data[el.id]=el.value; });
    localStorage.setItem(LS, JSON.stringify(data));
  }
  function load(){
    const data=JSON.parse(localStorage.getItem(LS)||'{}');
    Object.keys(data).forEach(k=>{ const el=$(k); if(el) el.value=data[k]; });
  }

  /* ---------- Sync groups across tabs/profile ---------- */
  const syncGroups={
    age:['bmr_age','profile_age'],
    gender:['bmr_gender','profile_gender'],
    height:['bmr_height','bmi_height'],
    weight:['bmr_weight','bmi_weight','bc_weight']
  };
  function syncField(changedId){
    for(const key in syncGroups){
      const g=syncGroups[key];
      if(g.includes(changedId)){
        const val = ($(changedId)||{}).value;
        g.forEach(id=>{ if(id!==changedId){ const el=$(id); if(el && el.value!==val) el.value=val; }});
      }
    }
  }

  /* ---------- Charts ---------- */
  let macroChart=null, mealChart=null, progressChart=null;
  const pieLabelsPlugin = {
    id: 'pieLabels',
    afterDraw(chart) {
      const {ctx} = chart;
      chart.data.datasets.forEach((dataset, i) => {
        const total = dataset.data.reduce((a,b)=>a+b,0) || 1;
        chart.getDatasetMeta(i).data.forEach((arc, index) => {
          const val = dataset.data[index];
          if (!val) return;
          const percent = Math.round((val/total)*100);
          const pos = arc.tooltipPosition();
          ctx.save();
          ctx.fillStyle = "#fff";
          ctx.font = "bold 12px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(percent+"%", pos.x, pos.y);
          ctx.restore();
        });
      });
    }
  };
  function setLegendPercents(chart){
    const ds = chart.data.datasets[0];
    chart.options.plugins.legend.labels.generateLabels = (chart) => {
      const labels = chart.data.labels;
      const total = ds.data.reduce((a,b)=>a+b,0) || 1;
      return labels.map((l,i)=>({
        text: `${l} â€” ${Math.round((ds.data[i]/total)*100)}%`,
        fillStyle: ds.backgroundColor[i],
        strokeStyle: ds.backgroundColor[i],
        lineWidth: 0,
        hidden: false,
        index: i
      }));
    };
  }

  /* ---------- BMR math ---------- */
  function bmrCalc(age, gender, h, w){
    if(!(age&&h&&w)) return 0;
    return gender==='male'
      ? 88.362 + 13.397*w + 4.799*h - 5.677*age
      : 447.593 + 9.247*w + 3.098*h - 4.330*age;
  }

  function recalc(){
    // Inputs
    const age=N(($('bmr_age')||{}).value) || N(($('profile_age')||{}).value);
    const gender=(($('bmr_gender')||{}).value)||(($('profile_gender')||{}).value)||'male';
    const h=N(($('bmr_height')||{}).value), w=N(($('bmr_weight')||{}).value);
    const act=N(($('bmr_activity')||{}).value)||1.55, adj=N(($('bmr_adjust')||{}).value)||0;

    // Core calc
    const bmr = Math.round(bmrCalc(age,gender,h,w) || 0);
    const tdee_base = Math.round((bmr||0) * act);

    // NEAT
    const steps = N(($('neat_steps')||{}).value);
    const kps = N(($('neat_kps')||{}).value || 0.045);
    const neat = Math.round(steps * kps);
    const useNeat = !!(($('neat_use')||{}).checked);
    const tdee_ref = useNeat ? Math.max(tdee_base, bmr + neat) : tdee_base;

    const target = Math.max(0, tdee_ref + adj);

    // Outputs
    const setTxt=(id,val)=>{ const el=$(id); if(el) el.textContent=val; };
    setTxt('bmr_out', bmr);
    setTxt('bmr_tdee', tdee_base);
    setTxt('bmr_tdee_ref', tdee_ref);
    setTxt('bmr_target', target);
    setTxt('bmr_target_basis', useNeat ? 'Refined (BMR+NEAT)' : 'Baseline (BMRÃ—Activity)');
    setTxt('neat_out', neat);
    setTxt('mc_bmr', bmr);
    setTxt('mc_tdee', tdee_base);
    setTxt('mc_tdee_ref', tdee_ref);
    setTxt('mc_target', target);
    setTxt('mc_neat', neat);
    localStorage.setItem('targetCals', target);

    // BMI
    const bh=N(($('bmi_height')||{}).value || h), bw=N(($('bmi_weight')||{}).value || w);
    const bmi = bh ? (bw/Math.pow(bh/100,2)) : 0;
    setTxt('bmi_out', bmi ? bmi.toFixed(1) : '0');
    setTxt('bmi_cat', bmi ? (bmi<18.5?'Underweight':bmi<25?'Normal':bmi<30?'Overweight':'Obese') : 'â€”');

    // Body Comp
    const bcw=N(($('bc_weight')||{}).value || w), bf=N(($('bc_bf')||{}).value || 0);
    const lean = bcw*(1-(bf/100||0));
    setTxt('bc_lean', lean ? lean.toFixed(1) : '0');
    setTxt('bc_fat', (bcw-(lean||0)) ? (bcw-(lean||0)).toFixed(1) : '0');

    // Macros (P+F editable, C = 100-(P+F))
    let pPct=N(($('pPct')||{}).value)||0, fPct=N(($('fPct')||{}).value)||0;
    if(pPct<0) pPct=0; if(fPct<0) fPct=0;
    let cPct = 100 - (pPct + fPct);
    if(cPct<0){ fPct = Math.max(0, fPct + cPct); cPct = 0; if($('fPct')) $('fPct').value = Math.round(fPct); }
    if($('cPct')) $('cPct').value = Math.round(cPct);
    if($('pPct')) $('pPct').value = Math.round(pPct);

    const pcals=target*(pPct/100), ccals=target*(cPct/100), fcals=target*(fPct/100);
    const pG=pcals/4, cG=ccals/4, fG=fcals/9;
    setTxt('pCals', Math.round(pcals)); setTxt('cCals', Math.round(ccals)); setTxt('fCals', Math.round(fcals));
    setTxt('pGr', Math.round(pG)); setTxt('cGr', Math.round(cG)); setTxt('fGr', Math.round(fG));

    // Macro pie
    const mctx = document.getElementById('macroChart')?.getContext('2d');
    if(mctx){
      if(!macroChart){
        macroChart = new Chart(mctx,{
          type:'pie',
          data:{ labels:['Protein','Fat','Carbs'],
            datasets:[{ data:[pPct,fPct,cPct], backgroundColor:['#004d40','#fbc02d','#a1887f'] }] },
          options:{ plugins:{ legend:{ position:'bottom' } } },
          plugins:[pieLabelsPlugin]
        });
        setLegendPercents(macroChart);
      }else{
        macroChart.data.datasets[0].data=[pPct,fPct,cPct];
        setLegendPercents(macroChart);
        macroChart.update();
      }
    }

    // Meal splits (25/30/30/15)
    const S={b:.25,l:.30,d:.30,s:.15}, R=x=>Math.round(x);
    setTxt('m1P', R(pG*S.b)); setTxt('m2P', R(pG*S.l)); setTxt('m3P', R(pG*S.d)); setTxt('sP', R(pG*S.s));
    setTxt('m1C', R(cG*S.b)); setTxt('m2C', R(cG*S.l)); setTxt('m3C', R(cG*S.d)); setTxt('sC', R(cG*S.s));
    setTxt('m1F', R(fG*S.b)); setTxt('m2F', R(fG*S.l)); setTxt('m3F', R(fG*S.d)); setTxt('sF', R(fG*S.s));
    setTxt('m1K', R(target*S.b)); setTxt('m2K', R(target*S.l)); setTxt('m3K', R(target*S.d)); setTxt('sK', R(target*S.s));

    // Meal stacked bars
    const labels=['Breakfast','Lunch','Dinner','Snacks'];
    const pBars=[pG*S.b*4,pG*S.l*4,pG*S.d*4,pG*S.s*4];
    const cBars=[cG*S.b*4,cG*S.l*4,cG*S.d*4,cG*S.s*4];
    const fBars=[fG*S.b*9,fG*S.l*9,fG*S.d*9,fG*S.s*9];
    const mealCtx=document.getElementById('mealChart')?.getContext('2d');
    if(mealCtx){
      if(!mealChart){
        mealChart=new Chart(mealCtx,{type:'bar',
          data:{labels,datasets:[
            {label:'Protein kcal',data:pBars,backgroundColor:'#004d40'},
            {label:'Carbs kcal',data:cBars,backgroundColor:'#fbc02d'},
            {label:'Fat kcal',data:fBars,backgroundColor:'#a1887f'}]},
          options:{plugins:{legend:{position:'bottom'}},scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}}
        });
      }else{
        mealChart.data.datasets[0].data=pBars;
        mealChart.data.datasets[1].data=cBars;
        mealChart.data.datasets[2].data=fBars;
        mealChart.update();
      }
    }

    // Measurement change
    function setChange(prefix,unit){
      const s=N(($(`${prefix}1`)||{}).value);
      const l=N(($(`${prefix}12`)||{}).value)||N(($(`${prefix}8`)||{}).value)||N(($(`${prefix}4`)||{}).value);
      const diff=(l&&s)?(l-s):0;
      const el=$(`${prefix}Change`); if(el) el.textContent=(diff>=0?'+':'')+(isFinite(diff)?diff.toFixed(1):'0')+' '+unit;
    }
    setChange('weight','kg'); setChange('bf','%'); setChange('waist','cm');

    // Progress numbers
    const curW=N(($('curW')||{}).value)||N(($('weight1')||{}).value)||w;
    const tarW=N(($('tarW')||{}).value);
    const curBF=N(($('curBF')||{}).value)||N(($('bf1')||{}).value)||N(($('bc_bf')||{}).value);
    const tarBF=N(($('tarBF')||{}).value);
    const dw=$('diffW'); if(dw) dw.textContent=(tarW&&curW)?(tarW-curW).toFixed(1):'0';
    const dbf=$('diffBF'); if(dbf) dbf.textContent=(tarBF&&curBF)?(tarBF-curBF).toFixed(1):'0';

    renderLogs();
  }

  /* ---------- Weight log + chart ---------- */
  const logTable = document.getElementById('logTable');
  const pctx=document.getElementById('progressChart')?.getContext('2d');
  function getLogs(){ try{ return JSON.parse(localStorage.getItem('weightLog')||'[]'); }catch(e){ return []; } }
  function setLogs(logs){ localStorage.setItem('weightLog', JSON.stringify(logs)); }
  function renderLogs(){
    const logs = getLogs();
    if(logTable){
      logTable.innerHTML='<tr><th>Date</th><th>Weight (kg)</th></tr>';
      logs.forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${e.date}</td><td>${e.weight}</td>`;
        logTable.appendChild(tr);
      });
    }
    const labels = logs.map(e=>e.date);
    const data = logs.map(e=>+e.weight);
    if(!window.progressChart && pctx){
      window.progressChart = new Chart(pctx,{type:'line',
        data:{labels,datasets:[{label:'Weight (kg)',data,borderColor:'#004d40',tension:0.2,fill:false}]},
        options:{plugins:{legend:{position:'bottom'}},scales:{y:{beginAtZero:false}}}});
    }else if(window.progressChart){
      window.progressChart.data.labels = labels;
      window.progressChart.data.datasets[0].data = data;
      window.progressChart.update();
    }
  }
  const addLogBtn = document.getElementById('addLog');
  if(addLogBtn){
    addLogBtn.addEventListener('click', ()=>{
      const d = (document.getElementById('logDate').value || new Date().toISOString().slice(0,10));
      const w = document.getElementById('logWeight').value;
      if(!w) return;
      let logs = getLogs();
      logs = logs.filter(e=>e.date!==d);
      logs.push({date:d, weight:w});
      logs.sort((a,b)=>a.date.localeCompare(b.date));
      setLogs(logs);
      renderLogs();
    });
  }

  /* ---------- Export & Email ---------- */
  window.exportDataEmail = function(toAddress=''){
    const lines=[];
    lines.push('Elevate Tracker Export');
    lines.push(new Date().toLocaleString());
    lines.push('');

    const fname = document.getElementById('profile_fullname')?.value || '';
    if(fname){ lines.push('Client: ' + fname); }
    const phone = document.getElementById('profile_phone')?.value || '';
    const email = document.getElementById('profile_email')?.value || '';
    if(phone||email) lines.push('Contact: ' + [phone,email].filter(Boolean).join(' | '));
    lines.push('');

    const BMR = document.getElementById('bmr_out')?.textContent || '0';
    const TDEE = document.getElementById('bmr_tdee')?.textContent || '0';
    const TDEER = document.getElementById('bmr_tdee_ref')?.textContent || '0';
    const TARGET = document.getElementById('bmr_target')?.textContent || '0';
    const NEAT = document.getElementById('neat_out')?.textContent || '0';
    const BASIS = document.getElementById('bmr_target_basis')?.textContent || '';
    lines.push('BMR: ' + BMR + ' kcal');
    lines.push('TDEE (Baseline): ' + TDEE + ' kcal');
    lines.push('NEAT: ' + NEAT + ' kcal/day');
    lines.push('TDEE (Refined): ' + TDEER + ' kcal');
    if(BASIS) lines.push('Target Basis: ' + BASIS);
    lines.push('Target Calories: ' + TARGET + ' kcal');
    lines.push('');

    const BMI = document.getElementById('bmi_out')?.textContent || '';
    const BMIC = document.getElementById('bmi_cat')?.textContent || '';
    if(BMI) lines.push('BMI: ' + BMI + (BMIC?(' ('+BMIC+')'):''));
    if(BMI) lines.push('');

    const L = document.getElementById('bc_lean')?.textContent || '';
    const F = document.getElementById('bc_fat')?.textContent || '';
    if(L || F){ if(L) lines.push('Lean Mass: ' + L + ' kg'); if(F) lines.push('Fat Mass: ' + F + ' kg'); lines.push(''); }

    const pPct = document.getElementById('pPct')?.value || '';
    const fPct = document.getElementById('fPct')?.value || '';
    const cPct = document.getElementById('cPct')?.value || '';
    const pGr  = document.getElementById('pGr')?.textContent || '';
    const cGr  = document.getElementById('cGr')?.textContent || '';
    const fGr  = document.getElementById('fGr')?.textContent || '';
    lines.push('Macros:');
    if(pPct) lines.push(`â€¢ Protein: ${pPct}%` + (pGr?` (${pGr} g)`:``));
    if(cPct) lines.push(`â€¢ Carbs: ${cPct}%` + (cGr?` (${cGr} g)`:``));
    if(fPct) lines.push(`â€¢ Fat: ${fPct}%`   + (fGr?` (${fGr} g)`:``));
    lines.push('');

    lines.push('Weight Log:');
    const logs = (function(){ try{return JSON.parse(localStorage.getItem('weightLog')||'[]')}catch(e){return[]} })();
    if(logs.length){ logs.forEach(e=>lines.push(`${e.date} â€” ${e.weight} kg`)); } else { lines.push('(no entries)'); }

    const subject='Elevate Tracker Export';
    const body=lines.join('\n');
    const mailto='mailto:'+encodeURIComponent(toAddress)+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body);
    window.location.href=mailto;
  };

  /* ---------- Icon + Manifest + SW (all embedded) ---------- */
  function createIcon(size=512){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const ctx=c.getContext('2d');

    // Rounded navy background
    const r=size*0.18, w=size, h=size;
    ctx.fillStyle='#0a1a2b';
    ctx.beginPath();
    ctx.moveTo(r,0); ctx.lineTo(w-r,0); ctx.quadraticCurveTo(w,0,w,r);
    ctx.lineTo(w,h-r); ctx.quadraticCurveTo(w,h,w-r,h);
    ctx.lineTo(r,h); ctx.quadraticCurveTo(0,h,0,h-r);
    ctx.lineTo(0,r); ctx.quadraticCurveTo(0,0,r,0);
    ctx.closePath(); ctx.fill();

    // Gold gradient symbol (abstract upward arrow/triangle)
    const grad=ctx.createLinearGradient(0,0,0,h);
    grad.addColorStop(0,'#ffdf8a');   // light gold
    grad.addColorStop(1,'#f3c14b');   // deep gold
    ctx.fillStyle=grad;

    // Triangle
    const pad=size*0.22;
    ctx.beginPath();
    ctx.moveTo(size/2, pad);
    ctx.lineTo(w-pad, h-pad);
    ctx.lineTo(pad, h-pad);
    ctx.closePath();
    ctx.fill();

    // Inner cut (navy) to create "stylish" chevron
    ctx.fillStyle='#0a1a2b';
    const inset=size*0.08;
    ctx.beginPath();
    ctx.moveTo(size/2, pad+inset);
    ctx.lineTo(w-(pad+inset), h-(pad+inset));
    ctx.lineTo(pad+inset, h-(pad+inset));
    ctx.closePath();
    ctx.fill();

    // Gold vertical bar (implies "E"/elevate)
    ctx.fillStyle=grad;
    const bw=size*0.10;
    ctx.fillRect(size/2 - bw/2, h*0.36, bw, h*0.48);

    return c.toDataURL('image/png');
  }

  function injectPWA(){
    const icon512=createIcon(512);
    const icon192=createIcon(192);
    const icon180=createIcon(180);

    // Icons for browser + iOS
    const apple = document.getElementById('dyn-apple-icon'); apple.setAttribute('href', icon180);
    const fav = document.getElementById('dyn-favicon'); fav.setAttribute('href', icon192);

    // Manifest (as blob)
    const manifest = {
      name: "Elevate Tracker",
      short_name: "Elevate",
      start_url: "./",
      display: "standalone",
      background_color: "#0a1a2b",
      theme_color: "#0a1a2b",
      icons: [
        {src: icon192, sizes: "192x192", type: "image/png"},
        {src: icon512, sizes: "512x512", type: "image/png"}
      ]
    };
    const manBlob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
    const manURL = URL.createObjectURL(manBlob);
    document.getElementById('dyn-manifest').setAttribute('href', manURL);

    // Minimal service worker (embedded) for standalone feel
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install',e=>self.skipWaiting());
        self.addEventListener('activate',e=>self.clients.claim());
        self.addEventListener('fetch',()=>{});
      `;
      const swBlob = new Blob([swCode], {type:'text/javascript'});
      const swURL = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swURL).catch(()=>{});
    }
  }

  /* ---------- Listeners + boot ---------- */
  document.addEventListener('input', (e)=>{
    if(!e.target.matches('input,select,textarea')) return;
    syncField(e.target.id);
    recalc();
    save();
  });
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.id==='neat_use'){ recalc(); save(); }
  });

  load();
  recalc();
  renderLogs();
  injectPWA();
})();
</script>
</body>
</html>
